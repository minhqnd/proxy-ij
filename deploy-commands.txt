# HTTPS Proxy Deployment Commands
# Copy-paste t·ª´ng section n√†y v√†o terminal

# ===================
# SECTION 1: Upload Files t·ª´ Local
# ===================
# Thay your-key.pem b·∫±ng ƒë∆∞·ªùng d·∫´n SSH key th·ª±c t·∫ø c·ªßa b·∫°n

scp -i your-key.pem https-intercepting-proxy.js ubuntu@host.minhqnd.com:~/
scp -i your-key.pem setup-https-interception.sh ubuntu@host.minhqnd.com:~/
scp -i your-key.pem package.json ubuntu@host.minhqnd.com:~/

# ===================
# SECTION 2: SSH v√†o EC2
# ===================

ssh -i your-key.pem ubuntu@host.minhqnd.com

# ===================
# SECTION 3: Setup tr√™n EC2 (ch·∫°y t·ª´ng l·ªánh)
# ===================

# C·∫≠p nh·∫≠t system
sudo apt-get update

# C√†i OpenSSL (c·∫ßn cho certificate generation)
sudo apt-get install -y openssl

# C√†i dependencies
npm install

# D·ª´ng proxy hi·ªán t·∫°i
pm2 stop all
pm2 delete all

# Kh·ªüi ƒë·ªông HTTPS intercepting proxy
pm2 start https-intercepting-proxy.js --name "https-proxy" --env production

# Ki·ªÉm tra status
pm2 status

# Xem logs
pm2 logs https-proxy --lines 15

# Test health check
curl http://localhost:8080/proxy-health

# ===================
# SECTION 4: Test t·ª´ Local (exit SSH tr∆∞·ªõc)
# ===================

# Exit ra kh·ªèi SSH
exit

# Test proxy t·ª´ local
curl -s http://host.minhqnd.com:8080/proxy-health

# Test HTTP injection
curl -x http://host.minhqnd.com:8080 -s http://httpbin.org/html | grep -i "proxy\|inject"

# Test HTTPS connection (s·∫Ω c√≥ certificate warning)
curl -x http://host.minhqnd.com:8080 -k -I https://example.com

# ===================
# SECTION 5: Browser Configuration
# ===================

# C·∫•u h√¨nh proxy trong browser:
# HTTP Proxy: host.minhqnd.com:8080
# HTTPS Proxy: host.minhqnd.com:8080

# Test URLs:
# http://example.com (s·∫Ω c√≥ injection button)
# https://example.com (certificate warning ‚Üí click Advanced ‚Üí Proceed ‚Üí s·∫Ω c√≥ injection button)

# ===================
# EXPECTED RESULTS
# ===================

# ‚úÖ PM2 status: https-proxy running
# ‚úÖ Health check: {"type":"https-intercepting-proxy","supports":["HTTP","HTTPS","HTTPS-Interception"]}
# ‚úÖ HTTP injection: Button "üîí HTTPS Intercepted" xu·∫•t hi·ªán
# ‚ö†Ô∏è HTTPS warnings: Certificate warnings l√† b√¨nh th∆∞·ªùng
# üîí HTTPS injection: C·∫ßn accept certificate ƒë·ªÉ test